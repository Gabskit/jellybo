name: Android CI â€” Capacitor

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-electron:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (root)
        run: npm install --no-audit --no-fund

      - name: Compile TypeScript (root)
        run: npx tsc

      - name: Build Electron
        working-directory: electron
        run: |
          npm install --no-audit --no-fund
          npm run build || true

      - name: Upload Electron build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: electron-build
          path: |
            electron/dist/**
            electron/build/**
            electron/out/**
            electron/**/dist/**

  build-android:
    needs: build-electron
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Generate Android mipmaps
        run: |
          if [ -f ./scripts/generate-mipmaps.js ]; then
            npm run generate-mipmaps || true
          else
            echo "No generate-mipmaps script found, skipping"
          fi

      - name: Optional web build
        run: npm run build || true

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Install Android command-line tools and SDK
        run: |
          set -eux
          ANDROID_ROOT="$HOME/android-sdk"
          mkdir -p "$ANDROID_ROOT"
          cd "$ANDROID_ROOT"
          curl -sSfL "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip" -o cmdline.zip
          unzip -q cmdline.zip -d cmdline-tools-temp
          mkdir -p cmdline-tools/latest
          mv cmdline-tools-temp/cmdline-tools/* cmdline-tools/latest/ || true
          rm -rf cmdline-tools-temp cmdline.zip
          echo "ANDROID_SDK_ROOT=$ANDROID_ROOT" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_ROOT" >> $GITHUB_ENV
          echo "$ANDROID_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_ROOT/platform-tools" >> $GITHUB_PATH
          # Install required SDK components
            "$ANDROID_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_ROOT" "platform-tools" "platforms;android-36" "build-tools;36.0.0"
          yes | "$ANDROID_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_ROOT" --licenses || true

      - name: Sync Capacitor Android
        run: npx cap sync android

      - name: Build Android (debug)
        working-directory: android
        run: |
          set -eux
          echo "--- Environment ---"
          echo "ANDROID_HOME=$ANDROID_HOME"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          env | sort
          echo "--- Gradle version ---"
          ./gradlew -v
          echo "--- Listing android dir ---"
          ls -la
          echo "--- Building (stacktrace + info) ---"
          ./gradlew assembleDebug --no-daemon --stacktrace --info 2>&1 | tee ../build-android.log || (cat ../build-android.log && false)

      - name: Upload Android build log
        uses: actions/upload-artifact@v4
        with:
          name: android-build-log
          path: android/../build-android.log

      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: android/app/build/outputs/**/*.apk
  # end of jobs