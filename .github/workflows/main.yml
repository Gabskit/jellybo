name: Build Jellybo Multiplatform
on:
  push:
    branches: [ main ]

jobs:
  build-all:
    name: Build for Android, iOS and Fedora
    # Usamos macOS para poder compilar iOS, y desde aquí mismo sacamos los demás
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      # --- ANDROID ---
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Build Android APK
        run: |
          npx cap sync android
          cd android
          # Aseguramos que el wrapper tenga permisos
          chmod +x gradlew
          # FORZAR GRADLE 8.5 (Cambiamos el archivo directamente en el server)
          sed -i 's/gradle-.*-all.zip/gradle-8.5-all.zip/g' gradle/wrapper/gradle-wrapper.properties
                                                            
          # Inyectamos configuraciones de emergencia
          echo "org.gradle.dependency.verification=off" >> gradle.properties
          echo "org.gradle.vfs.watch=false" >> gradle.properties
                                                                                          
          # Eliminamos cualquier rastro de cache local si existiera
          rm -rf .gradle
                                                                                                                        
          # Compilamos forzando un solo hilo y sin demonio
          ./gradlew assembleDebug --no-daemon --no-parallel --max-workers=1 --stacktrace
      # --- LINUX / FEDORA (Vía Electron) ---
      - name: Build Fedora RPM (ARM64)
        run: |
          npx cap sync @capacitor-community/electron
          cd electron
          npm install
          # Instalamos electron-builder si no está
          npm install electron-builder --save-dev
          npm run build:linux
          
      # --- iOS ---
      #- name: Build iOS
      #  run: |
      #    npx cap sync ios
      #    cd ios/App && pod install
      #    xcodebuild -workspace App.xcworkspace -scheme App -configuration Debug -destination 'generic/platform=iOS' build CODE_SIGNING_ALLOWED=NO

      # --- UPLOAD RESULTS ---
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Jellybo-Package
          path: |
            android/app/build/outputs/apk/debug/app-debug.apk
            electron/out/**/*.rpm
            #ios/App/build/Release-iphoneos/*.app